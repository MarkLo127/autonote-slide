'use client';

import { useEffect, useMemo, useState } from 'react';
import { useAppState } from '@/contexts/app-state';
import { SectionShell, EmptySurface } from '@/components/section-shell';
import styles from './summaries.module.css';

export default function SummariesPage() {
  const { documents } = useAppState();
  const [query, setQuery] = useState('');
  const [selectedId, setSelectedId] = useState<string | null>(documents[0]?.id ?? null);

  const activeDoc = useMemo(() => documents.find((doc) => doc.id === selectedId) ?? documents[0], [
    documents,
    selectedId
  ]);

  useEffect(() => {
    if (!documents.length) {
      setSelectedId(null);
      return;
    }
    const exists = selectedId ? documents.some((doc) => doc.id === selectedId) : false;
    if (!selectedId || !exists) {
      setSelectedId(documents[0].id);
    }
  }, [documents, selectedId]);

  const summaries = useMemo(() => {
    if (!activeDoc) return [];
    return activeDoc.paragraph_summaries.filter((item) =>
      query ? item.summary.toLowerCase().includes(query.toLowerCase()) : true
    );
  }, [activeDoc, query]);

  if (!documents.length) {
    return (
      <SectionShell
        title="ÊëòË¶ÅÊï¥ÁêÜÁÆ°ÁêÜ"
        subtitle="ÁÆ°ÁêÜÊÇ®ÁöÑÊñáÊ™îÊëòË¶Å"
        totalLabel="Á∏ΩÊëòË¶Å"
        totalCount={0}
        searchPlaceholder="ÊêúÂ∞ãÊëòË¶ÅÂÖßÂÆπ..."
        onSearch={setQuery}
      >
        <EmptySurface icon="üìò" title="ÈÇÑÊ≤íÊúâÁîüÊàê‰ªª‰ΩïÊëòË¶Å" description="ÈñãÂßãËôïÁêÜÊñáÊ™î‰∏¶ÁîüÊàêÊÇ®ÁöÑÁ¨¨‰∏ÄÂÄãÊëòË¶Å" />
      </SectionShell>
    );
  }

  return (
    <SectionShell
      title="ÊëòË¶ÅÊï¥ÁêÜÁÆ°ÁêÜ"
      subtitle="ÁÆ°ÁêÜÊÇ®ÁöÑÊñáÊ™îÊëòË¶Å"
      totalLabel="ÊÆµËêΩÊëòË¶Å"
      totalCount={activeDoc ? activeDoc.paragraph_summaries.length : 0}
      searchPlaceholder="ÊêúÂ∞ãÊëòË¶ÅÂÖßÂÆπ..."
      onSearch={setQuery}
    >
      <div className={styles.wrapper}>
        <div className={styles.selector}>
          <span>ÈÅ∏ÊìáÊñáÊ™îÔºö</span>
          <select
            value={activeDoc?.id ?? ''}
            onChange={(event) => setSelectedId(event.target.value)}
          >
            {documents.map((doc) => (
              <option key={doc.id} value={doc.id}>
                {doc.filename}
              </option>
            ))}
          </select>
        </div>

        <div className={styles.summaryList}>
          {summaries.map((item) => {
            const paragraph = activeDoc?.paragraphs.find((p) => p.index === item.paragraph_index);
            return (
              <article key={item.paragraph_index} className={styles.summaryItem}>
                <header>
                  <span>ÊÆµËêΩ {item.paragraph_index + 1}</span>
                  <span>{paragraph?.text.length ?? 0} Â≠ó</span>
                </header>
                <p>{item.summary}</p>
              </article>
            );
          })}
        </div>
      </div>
    </SectionShell>
  );
}
